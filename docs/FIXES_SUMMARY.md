# ğŸ”§ è®­ç»ƒé—®é¢˜ä¿®å¤æ€»ç»“

åŸºäºä½ æä¾›çš„ Epoch 14-16 è®­ç»ƒæ—¥å¿—ï¼Œæˆ‘å·²è¯†åˆ«å¹¶ä¿®å¤äº† **3 ä¸ªå…³é”®é—®é¢˜**ï¼š

## ğŸš¨ é—®é¢˜ 1: CE æŸå¤±å¡åœ¨ 5.95 ä¸ä¸‹é™

### **ç—‡çŠ¶åˆ†æ**
- CE æŸå¤±å§‹ç»ˆçº¦ç­‰äº `ln(num_classes) â‰ˆ 5.95`
- åˆ†ç±»å‡†ç¡®ç‡æ¥è¿‘éšæœºæ°´å¹³
- è¯´æ˜åˆ†ç±»å¤´å®Œå…¨æ²¡æœ‰å­¦åˆ°ä»»ä½•ä¸œè¥¿

### **å¯èƒ½åŸå› **
1. âŒ æ ‡ç­¾ä¸è¿ç»­æˆ–è¶…å‡º `num_classes` èŒƒå›´
2. âŒ åˆ†ç±»å™¨å‚æ•°ä¸åœ¨ä¼˜åŒ–å™¨ä¸­
3. âŒ æ¢¯åº¦è¢« `.detach()` é˜»æ–­
4. âŒ SDM æŸå¤±æƒé‡è¿‡å¤§ï¼Œå‹åˆ¶äº† CE æŸå¤±

### **å·²å®æ–½ä¿®å¤**
```python
# âœ… ä¿®å¤2: CEæŸå¤±è¯Šæ–­ - åœ¨ train_epoch() ä¸­æ·»åŠ 
if batch_idx == 0:
    print(f"labelsèŒƒå›´: {labels.min().item()} - {labels.max().item()}")
    print(f"model.num_classes: {model.num_classes}")
    print(f"ç†è®ºéšæœºCE: {np.log(model.num_classes):.3f}")
    
    # æ£€æŸ¥åˆ†ç±»å™¨å‚æ•°æ˜¯å¦å¯è®­ç»ƒ
    classifier_params = []
    for name, param in model.named_parameters():
        if 'classifier' in name and param.requires_grad:
            classifier_params.append(name)
    print(f"å¯è®­ç»ƒåˆ†ç±»å™¨å‚æ•°: {classifier_params}")
    
    if labels.max().item() >= model.num_classes:
        logging.error(f"âŒ æ ‡ç­¾è¶…å‡ºèŒƒå›´!")
```

### **è¯Šæ–­å·¥å…·**
è¿è¡Œ `debug_ce_issue.py` è¿›è¡Œæ·±åº¦è¯Šæ–­ï¼š
```bash
python debug_ce_issue.py
```

---

## ğŸš¨ é—®é¢˜ 2: "æ— æ­£æ ·æœ¬" å¯¼è‡´ SDM æŸå¤±é¢‘ç¹ä¸º 0

### **ç—‡çŠ¶åˆ†æ**
- æ—¥å¿—æ˜¾ç¤ºå¤šæ¬¡ "âš ï¸ å‘ç°Nè¡Œæ— æ­£æ ·æœ¬"
- `valid_rows` ç»å¸¸åªæœ‰ 2-5 ä¸ª
- SDM æŸå¤±ç»å¸¸ä¸º 0ï¼Œæ— æ³•è¿›è¡Œæ¨¡æ€å¯¹é½

### **æ ¹æœ¬åŸå› **
é‡‡æ ·å™¨æ²¡æœ‰ä¿è¯æ¯ä¸ª batch ä¸­çš„ ID åŒæ—¶åŒ…å«ï¼š
- â‰¥1 å¼  RGB (vis) æ¨¡æ€
- â‰¥1 å¼ é RGB æ¨¡æ€ (nir/sk/cp/text)

### **å·²å®æ–½ä¿®å¤**
```python
# âœ… ä¿®å¤1: ä½¿ç”¨MultiModalBalancedSamplerç¡®ä¿æ¯ä¸ªIDéƒ½æœ‰RGB+éRGBé…å¯¹
train_sampler = MultiModalBalancedSampler(
    train_dataset, 
    actual_batch_size, 
    num_instances=num_instances,
    seed=getattr(config, 'sampler_seed', 42)
)

# éªŒè¯é‡‡æ ·å™¨æ•ˆæœ
pairable_ratio = pairable_check / len(unique_ids) if len(unique_ids) > 0 else 0
logging.info(f"é‡‡æ ·å™¨éªŒè¯: {len(unique_ids)}ä¸ªID, å¯é…å¯¹ç‡: {pairable_ratio:.1%}")

if pairable_ratio < 0.8:
    logging.warning(f"âš ï¸ å¯é…å¯¹ç‡è¿‡ä½ï¼Œå›é€€åˆ°ModalAwarePKSampler")
```

### **è¯Šæ–­å·¥å…·**
è¿è¡Œ `debug_sampling_issue.py` åˆ†æé‡‡æ ·æ•ˆæœï¼š
```bash
python debug_sampling_issue.py
```

---

## ğŸš¨ é—®é¢˜ 3: BN ç‰¹å¾èŒƒæ•°å¼‚å¸¸ (21-22) + "æ­£åˆ™åŒ–æœªç”Ÿæ•ˆ"

### **ç—‡çŠ¶åˆ†æ**
- `Feat(BN)â‰ˆ21â€“22` æŒç»­æŠ¥è­¦
- åå¤å‡ºç° "æ­£åˆ™åŒ–æœªç”Ÿæ•ˆ" è­¦å‘Š
- ç‰¹å¾èŒƒæ•°è¿œè¶…åˆç†èŒƒå›´

### **å¯èƒ½åŸå› **
1. âŒ æ²¡æœ‰ä½¿ç”¨ L2 å½’ä¸€åŒ–
2. âŒ ç‰¹å¾æ­£åˆ™åŒ–æƒé‡ `lambda_norm` è¿‡å°
3. âŒ é˜ˆå€¼è®¾ç½®ä¸å½“ï¼ˆå¦‚æœä½¿ç”¨äº† L2 å½’ä¸€åŒ–ï¼ŒèŒƒæ•°åº”æ¥è¿‘ 1ï¼‰

### **å·²å®æ–½ä¿®å¤**
```python
# âœ… ä¿®å¤3: è°ƒæ•´BNç‰¹å¾èŒƒæ•°é˜ˆå€¼ - è‡ªé€‚åº”æ£€æµ‹L2å½’ä¸€åŒ–
using_l2_norm = False
if isinstance(outputs, dict) and 'bn_features' in outputs:
    bn_feats = outputs['bn_features']
    sample_norm = bn_feats[0].norm(p=2).item()
    if 0.8 <= sample_norm <= 1.2:  # æ¥è¿‘å•ä½èŒƒæ•°
        using_l2_norm = True

# æ ¹æ®æ˜¯å¦ä½¿ç”¨L2å½’ä¸€åŒ–è°ƒæ•´é˜ˆå€¼
if using_l2_norm:
    # L2å½’ä¸€åŒ–æƒ…å†µä¸‹ï¼ŒèŒƒæ•°åº”è¯¥æ¥è¿‘1
    threshold = 2.0
else:
    # éå½’ä¸€åŒ–æƒ…å†µä¸‹ï¼ŒèŒƒæ•°é˜ˆå€¼è®¾ä¸ºæ›´åˆç†çš„å€¼
    threshold = 15.0
```

---

## ğŸ“‹ ä¿®å¤éªŒè¯æ¸…å•

### ç«‹å³æ‰§è¡Œæ­¥éª¤
1. **è¿è¡Œè¯Šæ–­è„šæœ¬**ï¼š
```bash
python debug_ce_issue.py          # è¯Šæ–­CEé—®é¢˜
python debug_sampling_issue.py    # è¯Šæ–­é‡‡æ ·é—®é¢˜
```

2. **å¿«é€Ÿæµ‹è¯•ä¿®å¤æ•ˆæœ**ï¼š
```bash
python quickfix_test.py           # è¿è¡Œ1ä¸ªepochéªŒè¯ä¿®å¤
```

3. **è§‚å¯Ÿå…³é”®æŒ‡æ ‡**ï¼š
   - CE æŸå¤±åº”å¼€å§‹ä¸‹é™ï¼ˆ< 5.5 è¡¨ç¤ºå­¦ä¹ ä¸­ï¼‰
   - å¯é…å¯¹ç‡åº” > 80%
   - ç‰¹å¾èŒƒæ•°è­¦å‘Šåº”æ˜¾è‘—å‡å°‘

### æœŸæœ›ç»“æœ
ä¿®å¤æˆåŠŸåï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š
- âœ… CE æŸå¤±ä» 5.95 å¼€å§‹ä¸‹é™ï¼Œåˆ†ç±»å‡†ç¡®ç‡é€æ­¥æå‡
- âœ… "æ— æ­£æ ·æœ¬" è­¦å‘Šæ¶ˆå¤±ï¼Œ`valid_rows` æ¥è¿‘ batch_size
- âœ… ç‰¹å¾èŒƒæ•°è­¦å‘Šå‡å°‘ï¼ŒèŒƒæ•°åœ¨åˆç†åŒºé—´

### å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

å¦‚æœä¿®å¤åé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·è¿è¡Œï¼š
```bash
python debug_ce_issue.py > ce_diagnosis.log 2>&1
python debug_sampling_issue.py > sampling_diagnosis.log 2>&1
```

ç„¶åæä¾›è¯Šæ–­æ—¥å¿—ï¼Œæˆ‘å°†è¿›è¡Œæ›´æ·±åº¦çš„åˆ†æã€‚

---

## ğŸ¯ æ ¸å¿ƒå»ºè®®

1. **å…ˆè§£å†³ CE æŸå¤±é—®é¢˜**ï¼šè¿™æ˜¯æœ€åŸºç¡€çš„ï¼Œå¦‚æœåˆ†ç±»å¤´ä¸å­¦ä¹ ï¼Œå…¶ä»–ä¼˜åŒ–éƒ½æ²¡æ„ä¹‰
2. **ç¡®ä¿é‡‡æ ·å™¨å¯é…å¯¹ç‡ > 80%**ï¼šè¿™æ˜¯ SDM æŸå¤±æ­£å¸¸å·¥ä½œçš„å‰æ
3. **æ ¹æ®å®é™…ä½¿ç”¨çš„å½’ä¸€åŒ–ç­–ç•¥è°ƒæ•´èŒƒæ•°é˜ˆå€¼**ï¼šé¿å…è¯¯æŠ¥

**ä¼˜å…ˆçº§**: CE é—®é¢˜ > é‡‡æ ·é—®é¢˜ > ç‰¹å¾èŒƒæ•°é—®é¢˜