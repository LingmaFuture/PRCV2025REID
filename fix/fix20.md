# Fix20: Guide20æ•°æ®é›†ä¿®å¤ä¸è®­ç»ƒæµç¨‹å®Œå–„

**ä¿®å¤æ—¥æœŸ**: 2024å¹´
**ä¿®å¤èŒƒå›´**: æ•°æ®é›†åŠ è½½ã€è®­ç»ƒæµç¨‹ã€è¿›åº¦æ¡æ˜¾ç¤º

## ğŸ¯ é—®é¢˜æ¦‚è¿°

åœ¨Guide20å¤šæ¨¡æ€æ•°æ®é›†å®ç°åï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç°äº†å¤šä¸ªå…³é”®é”™è¯¯ï¼š
1. `AttributeError: 'MultiModalDataset' object has no attribute 'id_to_annotations'`
2. å¤§é‡ `KeyError: 'person_id_str'` é”™è¯¯
3. `ZeroDivisionError: division by zero`
4. è®­ç»ƒè¿›åº¦æ¡æ˜¾ç¤ºå¼‚å¸¸ï¼Œä¸€ç›´åœç•™åœ¨"Epoch 1"

## âœ… ä¿®å¤è¯¦æƒ…

### 1. æ•°æ®é›†åŠ è½½ä¿®å¤

#### é—®é¢˜1.1: `id_to_annotations` å±æ€§ç¼ºå¤±
**æ–‡ä»¶**: `datasets/dataset.py`
**ä½ç½®**: `_get_available_person_ids` æ–¹æ³•ç¬¬415è¡Œ

**é”™è¯¯åŸå› **:
- `_load_annotations` æ–¹æ³•åªåˆ›å»ºäº† `self.samples` å±æ€§
- `_get_available_person_ids` å°è¯•è®¿é—®ä¸å­˜åœ¨çš„ `self.id_to_annotations` å±æ€§

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼š
json_ids = set(self.id_to_annotations.keys())  # âŒ å±æ€§ä¸å­˜åœ¨

# ä¿®å¤åï¼š  
json_ids = set(sample['person_id'] for sample in self.samples)  # âœ… ä»å·²å­˜åœ¨çš„samplesè·å–
```

#### é—®é¢˜1.2: quick_scanå‡½æ•°å‚æ•°é”™è¯¯
**æ–‡ä»¶**: `test_guide20_fix.py`
**ä½ç½®**: ç¬¬51è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼š
quick_scan(dataset, max_samples=min(50, len(dataset)))  # âŒ å‚æ•°åé”™è¯¯

# ä¿®å¤åï¼š
quick_scan(dataset, n=min(50, len(dataset)))  # âœ… æ­£ç¡®å‚æ•°å
```

### 2. è®­ç»ƒä»£ç ä¿®å¤

#### é—®é¢˜2.1: analyze_dataset_sampling_capabilityå‡½æ•°é”™è¯¯
**æ–‡ä»¶**: `train.py`
**ä½ç½®**: ç¬¬477è¡Œ

**é”™è¯¯åŸå› **:
- å°è¯•è®¿é—® `dataset.data_list[i]['person_id_str']` å­—æ®µ
- ä½†å®é™…æ•°æ®ç»“æ„ä¸­åªæœ‰ `person_id` å­—æ®µï¼ˆæ•´æ•°ç±»å‹ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼š
pid = dataset.data_list[i]['person_id_str']  # âŒ å­—æ®µä¸å­˜åœ¨

# ä¿®å¤åï¼š
pid = str(dataset.data_list[i]['person_id'])  # âœ… æ­£ç¡®è·å–å¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²
```

#### é—®é¢˜2.2: build_val_presence_tableå‡½æ•°é”™è¯¯
**æ–‡ä»¶**: `train.py`
**ä½ç½®**: ç¬¬277è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼š
pid_str = entry['person_id_str']  # âŒ å­—æ®µä¸å­˜åœ¨

# ä¿®å¤åï¼š
pid_str = str(entry['person_id'])  # âœ… æ­£ç¡®è·å–å¹¶è½¬æ¢
```

#### é—®é¢˜2.3: é™¤é›¶é”™è¯¯ä¿æŠ¤
**æ–‡ä»¶**: `train.py`
**ä½ç½®**: ç¬¬520è¡Œ

**é”™è¯¯åŸå› **:
- å½“ `total_ids = 0` æ—¶ï¼Œè®¡ç®—ç™¾åˆ†æ¯”ä¼šå¯¼è‡´é™¤é›¶é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼š
print(f"  å¯é…å¯¹IDæ•° (Kâ‰¥{min_k}): {len(pairable_ids)} ({len(pairable_ids)/total_ids*100:.1f}%)")

# ä¿®å¤åï¼š
if total_ids > 0:
    print(f"  å¯é…å¯¹IDæ•° (Kâ‰¥{min_k}): {len(pairable_ids)} ({len(pairable_ids)/total_ids*100:.1f}%)")
else:
    print(f"  å¯é…å¯¹IDæ•° (Kâ‰¥{min_k}): {len(pairable_ids)} (æ— æ³•è®¡ç®—ç™¾åˆ†æ¯”ï¼šæ€»IDæ•°ä¸º0)")
    print("  âš ï¸ è­¦å‘Šï¼šæ²¡æœ‰æˆåŠŸåˆ†æåˆ°ä»»ä½•IDï¼Œè¯·æ£€æŸ¥æ•°æ®é›†ç»“æ„")
```

### 3. è¿›åº¦æ¡æ˜¾ç¤ºä¿®å¤

#### é—®é¢˜3.1: è¿›åº¦æ¡ç´¯ç§¯ä¸é‡ç½®
**æ–‡ä»¶**: `train.py`
**ä½ç½®**: `train_epoch` å‡½æ•°ç¬¬854-856è¡Œ

**é”™è¯¯åŸå› **:
- ä½¿ç”¨ `tqdm(dataloader, ...)` ç›´æ¥åŒ…è£…ï¼Œå¯¼è‡´æ¯ä¸ªepochç´¯ç§¯è®¡æ•°
- ç¼ºå°‘ `total` å‚æ•°å’Œæ­£ç¡®çš„æ›´æ–°æœºåˆ¶

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤å‰ï¼š
pbar = tqdm(dataloader, desc=f'Epoch {epoch}', 
            leave=True, ncols=120, mininterval=2.0, maxinterval=5.0,
            total=None)  # âŒ ç›´æ¥åŒ…è£…dataloaderï¼Œç´¯ç§¯è®¡æ•°

# ä¿®å¤åï¼š
total_batches = len(dataloader) if hasattr(dataloader, '__len__') else None
pbar = tqdm(total=total_batches, desc=f'Epoch {epoch}', 
            leave=False, ncols=120, mininterval=2.0, maxinterval=5.0)  # âœ… ç‹¬ç«‹åˆ›å»º
```

#### é—®é¢˜3.2: ç¼ºå°‘è¿›åº¦æ¡æ›´æ–°
**ä¿®å¤ä½ç½®**: å¤šå¤„

**ä¿®å¤æ–¹æ¡ˆ**:
1. **æ­£å¸¸batchå¤„ç†åæ›´æ–°**:
```python
# åœ¨ç¬¬1319è¡Œæ·»åŠ ï¼š
pbar.update(1)  # æ¯ä¸ªbatchå¤„ç†å®Œåæ›´æ–°
```

2. **continueè¯­å¥å‰æ›´æ–°** (3å¤„):
```python
# å†…å­˜ä¸è¶³è·³è¿‡æ—¶ï¼š
pbar.update(1)  # æ›´æ–°è¿›åº¦æ¡
continue

# NaNæŸå¤±è·³è¿‡æ—¶ï¼š
pbar.update(1)  # æ›´æ–°è¿›åº¦æ¡  
continue

# æ— æ•ˆæŸå¤±è·³è¿‡æ—¶ï¼š
pbar.update(1)  # æ›´æ–°è¿›åº¦æ¡
continue
```

3. **epochç»“æŸæ—¶å…³é—­**:
```python
# åœ¨ç¬¬1349è¡Œæ·»åŠ ï¼š
pbar.close()  # å…³é—­è¿›åº¦æ¡
```

## ğŸ“Š ä¿®å¤æ•ˆæœéªŒè¯

### Guide20æµ‹è¯•ç»“æœ
```
============================================================
æµ‹è¯•Guide20ä¿®å¤ï¼šå¤šæ¨¡æ€æ ·æœ¬æ„å»ºå’Œæ£€ç´¢  
============================================================
[INFO] æ„å»ºäº† 18420 ä¸ªå¤šæ¨¡æ€æ ·æœ¬
æ•°æ®é›†åŠ è½½ä¿¡æ¯:
  jsonä¸­çš„èº«ä»½ID: 400
  æœ€ç»ˆå¯ç”¨çš„èº«ä»½ID: 400
  ç¼ºå°‘visç›®å½•çš„èº«ä»½ID: 0
train dataset: 18420 samples, 400 identities
âœ… æ•°æ®é›†åŠ è½½æˆåŠŸï¼Œå…±18420ä¸ªæ ·æœ¬

ğŸ“Š æ ·æœ¬ç»“æ„éªŒè¯:
  æ ·æœ¬å­—æ®µ: ['person_id', 'pid', 'images', 'modality_mask', 'text', 'text_description', 'file_path', 'modality']
  imageså­—æ®µ: ['vis', 'nir', 'sk', 'cp']  
  modality_mask: {'vis': 1.0, 'nir': 1.0, 'sk': 1.0, 'cp': 1.0}
  æ–‡æœ¬é•¿åº¦: 206

ğŸ” æ¨¡æ€æ£€æµ‹åŠŸèƒ½æµ‹è¯•:
  æ ·æœ¬0æ¨¡æ€: {'text', 'cp', 'sk', 'vis', 'nir'}

ğŸš€ å¿«é€Ÿæ‰«æå‰50ä¸ªæ ·æœ¬:
[ä»…å›¾åƒ] æ¨¡æ€è®¡æ•°: {'sk': 50, 'vis': 50, 'nir': 50, 'cp': 50}
vis+évis é…å¯¹æ ·æœ¬: 50/50  æ¯”ä¾‹: 100.0%
âœ… æœªæ£€æµ‹åˆ°æ—§æ¨¡æ€åç§°ï¼Œè§„èŒƒåŒ–æˆåŠŸ

âœ… Guide20ä¿®å¤æµ‹è¯•å®Œæˆ!
```

### è®­ç»ƒæµç¨‹ä¿®å¤ç»“æœ
```
ä½¿ç”¨è®¾å¤‡: cuda
[INFO] æ„å»ºäº† 18420 ä¸ªå¤šæ¨¡æ€æ ·æœ¬
æ•°æ®é›†åŠ è½½ä¿¡æ¯:
  jsonä¸­çš„èº«ä»½ID: 400
  æœ€ç»ˆå¯ç”¨çš„èº«ä»½ID: 400  
  ç¼ºå°‘visç›®å½•çš„èº«ä»½ID: 0
train dataset: 18420 samples, 400 identities
æ•°æ®é›†åˆ’åˆ†ç»“æœ:
  åŸå§‹æ•°æ®é›†: 18420 æ ·æœ¬, 400 ä¸ªID
  è®­ç»ƒæ•°æ®é›†: 14910 æ ·æœ¬, 320 ä¸ªID (80.9%)
  éªŒè¯æ•°æ®é›†: 3510 æ ·æœ¬, 80 ä¸ªID (19.1%)

==================================================
æ•°æ®é›†é‡‡æ ·èƒ½åŠ›åˆ†æ
==================================================
[INFO] å¼€å§‹åˆ†ææ•°æ®é›†é‡‡æ ·èƒ½åŠ›...
æ•°æ®é›†ç»Ÿè®¡:
  æ€»IDæ•°: 320            # âœ… ä¸å†æ˜¯0
  æ€»æ ·æœ¬æ•°: 14910        # âœ… æ­£ç¡®ç»Ÿè®¡
  å„æ¨¡æ€åˆ†å¸ƒ: {'rgb': 14910}  # âœ… æ­£å¸¸åˆ†æ
  å¯é…å¯¹IDæ•° (Kâ‰¥2): 0 (0.0%)  # âœ… ä¸å†æŠ¥é”™

# âœ… è¿›åº¦æ¡æ­£å¸¸æ˜¾ç¤ºï¼ˆé¢„æœŸæ•ˆæœï¼‰ï¼š
Epoch 1: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1863/1863 [11:23<00:00, 2.72it/s, Loss=4.52, CE=4.52, ...]
Epoch 2:   0%|      |    0/1863 [00:00<?, ?it/s]  
Epoch 2:  10%|â–ˆ     |  186/1863 [01:08<10:15, 2.73it/s, Loss=3.21, CE=3.21, ...]
```

## ğŸ¯ æ ¸å¿ƒæ”¶è·

### 1. æ•°æ®ç»“æ„ä¸€è‡´æ€§çš„é‡è¦æ€§
- ç¡®ä¿ä»£ç ä¸­è®¿é—®çš„å­—æ®µåä¸å®é™…æ•°æ®ç»“æ„ä¸€è‡´
- `person_id`ï¼ˆæ•´æ•°ï¼‰vs `person_id_str`ï¼ˆå­—ç¬¦ä¸²ï¼‰çš„åŒºåˆ†

### 2. å¼‚å¸¸å¤„ç†çš„å®Œå¤‡æ€§
- æ·»åŠ é™¤é›¶ä¿æŠ¤ç­‰è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
- ç¡®ä¿æ‰€æœ‰å¯èƒ½çš„é”™è¯¯è·¯å¾„éƒ½æœ‰åˆé€‚çš„å¤„ç†

### 3. ç”¨æˆ·ç•Œé¢ä½“éªŒä¼˜åŒ–
- è¿›åº¦æ¡çš„æ­£ç¡®å®ç°å¯¹ç”¨æˆ·ä½“éªŒè‡³å…³é‡è¦
- ç¡®ä¿æ¯ä¸ªepochéƒ½èƒ½æ­£ç¡®é‡ç½®å’Œæ˜¾ç¤ºè¿›åº¦

### 4. ä»£ç å¤ç”¨çš„æ³¨æ„äº‹é¡¹
- å½“å‡½æ•°ç­¾åå‘ç”Ÿå˜åŒ–æ—¶ï¼Œç¡®ä¿æ‰€æœ‰è°ƒç”¨ç‚¹éƒ½å¾—åˆ°æ›´æ–°
- `quick_scan(ds, max_samples=...)` vs `quick_scan(ds, n=...)`

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **SDMæŸå¤±ä¼˜åŒ–**: å½“å‰SDMæŸå¤±ä¸º0ï¼Œéœ€è¦ä¼˜åŒ–é‡‡æ ·å™¨é…å¯¹ç­–ç•¥
2. **æ¨¡æ€å¹³è¡¡**: è®­ç»ƒé›†ä¸­åªæ˜¾ç¤º'rgb'æ¨¡æ€ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´æ¨¡æ€æ£€æµ‹é€»è¾‘
3. **é‡‡æ ·æ•ˆç‡**: æé«˜paired_idsçš„æ¯”ä¾‹ï¼Œä¼˜åŒ–è·¨æ¨¡æ€é…å¯¹

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ±‡æ€»

- âœ… `datasets/dataset.py`: ä¿®å¤`_get_available_person_ids`æ–¹æ³•
- âœ… `train.py`: ä¿®å¤å¤šä¸ªå‡½æ•°ä¸­çš„`person_id_str`é”™è¯¯å’Œè¿›åº¦æ¡æ˜¾ç¤º  
- âœ… `test_guide20_fix.py`: ä¿®å¤`quick_scan`å‡½æ•°è°ƒç”¨å‚æ•°ï¼ˆå·²åˆ é™¤ï¼‰

**æ€»è®¡ä¿®å¤**: 6ä¸ªä¸»è¦é—®é¢˜ï¼Œæ¶‰åŠæ•°æ®åŠ è½½ã€è®­ç»ƒæµç¨‹å’Œç”¨æˆ·ç•Œé¢æ˜¾ç¤ºçš„å®Œæ•´ä¿®å¤ã€‚
